<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" type="text/css" href="css/index.css"/>
  <script src="//xz.voicecloud.cn/activity/ai_niu/js/lxadp.min.js"></script>
  <title>Document</title>
</head>
<body>
  <div class="home">
    <p class="voice-txt"></p>
    
    <!--麦克风-->
    <div class="play-btn"></div>
    <img class="home-btn1" src="images/home-voice1.gif"/>
    <img class="home-btn2" src="images/home-voice2.gif"/>
  </div>
  
  <script src="//cdn.bootcss.com/eruda/1.3.1/eruda.min.js"></script><script>eruda.init();</script>
  <script src="//xz.voicecloud.cn/activity/ai_niu/js/ilingxi-1.0.0.js"></script>
  <script src="//cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>
  <script type="text/javascript">
    
    var ua = navigator.userAgent.toLocaleLowerCase(),
      LINGXI = /lingxi/.test(ua),
      WEIXIN = /micromessenger/.test(ua);

    
    // ***********获取录音权限时，快速点击触发touchend事件，长按时触发touchcancel事件*************
    
    
    // 麦克风逻辑
    // 麦克风逻辑
    $(".play-btn")
      .on('touchstart', startVoice)
      .on('touchcancel', voiceError)
      .on('touchend', endVoice);
    
    /**
     * @desc 开始语音识别
     * 
     */
    function startVoice(e) {
      // lxData.trackEvent('按住“麦克风”按钮');
      $('.home-btn1').hide();
      $('.home-btn2').show();
      
      btnStatus = false;
      $('.question-txt').attr('data-ios', 'data-ios'); //兼容IOS停止听写能力bug
      
      // 开始听写
      if (LINGXI) {
        lx.startListenTransfer({
          engine: 'CN', //CN、EN,不传默认CN
          isSaveAudio: true //是否保存录音文件
        });
      } else {
        wx.startRecord();
        e.preventDefault(); // 防止微信中长按出现菜单
      }
    }
    /**
     * @desc 语音识别被中断 
     * 
     */
    function voiceError() {
      clearInterval(countTimer);
      $('.home-btn1').show();
      $('.home-btn2').hide();
    }
    /**
     * @desc 获取语音识别结果
     * 
     */
    function endVoice() {
      $('.home-btn1').show();
      $('.home-btn2').hide();
      
      // 兼容IOS停止听写能力bug
      btnStatus = true;
      setTimeout(function () {
        if ($('.question-txt').attr('data-ios') === 'data-ios' && btnStatus) {
          changeQuestion('');
        }
      }, 6000);
      
      // 识别完成回调
      if (LINGXI) {
        lx.stopListenTransfer();// 停止听写
      } else {
        wx.stopRecord({
          success: function(res) {
            var localId = res.localId;
            wx.translateVoice({
              localId: localId, // 需要识别的音频的本地Id，由录音相关接口获得
              isShowProgressTips: 0, // 默认为1，显示进度提示
              success: function(res) {
                var text = res.translateResult; // 语音识别的结果
                $('.question-txt').removeAttr('data-ios', 'data-ios');
                if (text == undefined) {
                  changeQuestion(''); 
                } else {
                  changeQuestion(text); 
                }
              },
              fail: function (res) {
                $('.question-txt').removeAttr('data-ios', 'data-ios');
                changeQuestion('');
              }
            });
          }
        });
      }
    }
    
    if (LINGXI) {
      lx.onListenTransfer({
        complete: function(ret) {
          var text = ret.rawText, //转写文本内容
              audioId = ret.audioId;//本地录音文件Id
          
//        alert(JSON.stringify(ret));

          // 语音合成
          if (false) {
          	lx.startTTS({
              text: text, //合成文本
            });
          }
              
          $('.question-txt').removeAttr('data-ios', 'data-ios');
          changeQuestion(text);   
        },
        //听写异常
        fail: function(ret) {
          $('.question-playing').hide();
          $('.question-played').show();
          $('.question-run').hide();
          var code = ret.code; //错误编码
        }
      });
    }
    
    function changeQuestion(text) {
       $('.voice-txt').text(text); 
    }
  </script>
</body>
</html>
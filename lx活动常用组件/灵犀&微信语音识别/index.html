<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" type="text/css" href="css/index.css"/>
  <script src="//res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
  <script src="//cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>
  <script src="//xz.voicecloud.cn/activity/ai_niu/js/lxadp.min.js"></script>
  <script src="//xz.voicecloud.cn/activity/ai_niu/js/ilingxi-1.0.0.js"></script>
  <script src="//cdn.bootcss.com/eruda/1.3.1/eruda.min.js"></script><script>eruda.init();</script>
  <title>Document</title>
</head>
<body>
  <div class="home">
    <p class="voice-txt"></p>
    
    <!--麦克风-->
    <div class="play-btn"></div>
    <img class="home-mic" src="images/home-voice1.gif"/>
    <img class="home-mic-run" src="images/home-voice2.gif"/>
  </div>
  
  <script type="text/javascript">
    
    var ua = navigator.userAgent.toLocaleLowerCase(),
      LINGXI = /lingxi/.test(ua),
      WEIXIN = /micromessenger/.test(ua);

    
    // ***********获取录音权限时，快速点击触发touchend事件，长按时触发touchcancel事件*************
    
    
    // 麦克风逻辑
    // 麦克风逻辑
    $(".play-btn")
      .on('touchstart', startVoice)
      .on('touchcancel', breakVocie)
      .on('touchend', endVoice);
    
    /**
     * @desc 处理语音识别的文本文本
     */
    function changeVoiceTxt(text) {
      $('.voice-txt').text(text); 
    }
    
    var isIosVoiceEnd = true; // 防止识别状态下提示
    /**
     * @desc 开始语音识别
     * 
     */
    function startVoice(e) {
      // lxData.trackEvent('按住“麦克风”按钮');
      $('.home-mic').hide();
      $('.home-mic-run').show();
      
      isIosVoiceEnd = false;
      $('.voice-txt').attr('data-ios', 'isVoiceEnd'); //判断IOS是否识别完成
      
      // 开始听写
      if (LINGXI) {
        lx.startListenTransfer({
          engine: 'CN', //CN、EN,不传默认CN
          isSaveAudio: true //是否保存录音文件
        });
      } else if (WEIXIN) {
        wx.startRecord();
        e.preventDefault(); // 防止微信中长按出现菜单
      }
    }
    /**
     * @desc 语音识别被中断 
     * 
     */
    function breakVocie() {
      $('.home-mic').show();
      $('.home-mic-run').hide();
    }
    /**
     * @desc 获取语音识别结果
     * 
     */
    function endVoice() {
      $('.home-mic').show();
      $('.home-mic-run').hide();
      
      // 识别完成回调
      LINGXI && lxEndVoice();
      WEIXIN && wxEndVoice();
      
      /**
       * @desc 结束灵犀语音识别
       */
      function lxEndVoice() {
        lx.stopListenTransfer();// 停止听写
        
        isIosVoiceEnd = true;
        // 兼容灵犀IOS停止听写能力bug
        setTimeout(function () {
          if ($('.voice-txt').attr('data-ios') === 'isVoiceEnd' && isIosVoiceEnd) {
            changeVoiceTxt('');
          }
        }, 6000);
      }
      /**
       * @desc 结束微信语音识别
       */
      function wxEndVoice() {
        wx.stopRecord({
          success: function(res) {
            wx.translateVoice({
              localId: res.localId, // 需要识别的音频的本地Id，由录音相关接口获得
              isShowProgressTips: 1, // 默认为1，显示进度提示
              success: function(res) {
                res.translateResult === undefined ? changeVoiceTxt('') : changeVoiceTxt(text);
              },
              fail: function (res) {
                console.log('微信识别失败, res:' + res);
              }
            });
          }
        });
      }
    }
    
    LINGXI && lxVoiceCallback();
    
    /**
     * @desc 灵犀语音识别的回调
     */
    function lxVoiceCallback() {
      lx.onListenTransfer({
        complete: function(ret) {
          if (ret.errorCode === 100006) {
            alert('请打开麦克风权限');
            return;
          }
          var text = ret.rawText, // 转写文本内容
            audioId = ret.audioId; // 本地录音文件Id
            
          alert(audioId)
          $('.voice-txt').removeAttr('data-ios');
          changeVoiceTxt(text);   
        },
        //听写异常
        fail: function(ret) {
          var code = ret.code; //错误编码
        }
      });
    }
  </script>
</body>
</html>